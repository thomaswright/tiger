// Generated by ReScript, PLEASE EDIT WITH CARE

import * as Uuid from "uuid";
import * as Types from "./Types.res.mjs";
import * as React from "react";
import * as Common from "./Common.res.mjs";
import * as Caml_obj from "rescript/lib/es6/caml_obj.js";
import * as Caml_option from "rescript/lib/es6/caml_option.js";
import * as Core__Array from "@rescript/core/src/Core__Array.res.mjs";
import * as Core__Option from "@rescript/core/src/Core__Option.res.mjs";
import * as Tb from "react-icons/tb";
import * as JsxRuntime from "react/jsx-runtime";

function Project$Todo(props) {
  var setChecked = props.setChecked;
  var getTodos = props.getTodos;
  var newTodoAfter = props.newTodoAfter;
  var setFocusIdNext = props.setFocusIdNext;
  var setTodos = props.setTodos;
  var setDisplayElement = props.setDisplayElement;
  var setSelectedElement = props.setSelectedElement;
  var isSelected = props.isSelected;
  var updateTodo = props.updateTodo;
  var todo = props.todo;
  var match = React.useState(function () {
        return false;
      });
  var setStatusSelectIsOpen = match[1];
  var inputRef = React.useRef(null);
  var containerRef = React.useRef(null);
  var match$1 = React.useState(function () {
        return false;
      });
  var setStagedForDelete = match$1[1];
  var stagedForDelete = match$1[0];
  var onKeyDownContainer = function (e) {
    if (isSelected && Caml_obj.equal(Caml_option.nullable_to_opt(containerRef.current), Caml_option.nullable_to_opt(document.activeElement))) {
      return Common.mapNullable(containerRef.current, (function (dom) {
                    if (e.key === "s") {
                      e.preventDefault();
                      setStatusSelectIsOpen(function (param) {
                            return true;
                          });
                    }
                    if (e.key === "ArrowUp") {
                      e.preventDefault();
                      Common.focusPreviousClass(Types.listItemClass, dom);
                    }
                    if (e.key === "ArrowDown") {
                      e.preventDefault();
                      Common.focusNextClass(Types.listItemClass, dom);
                    }
                    if (e.key === "Backspace" && e.metaKey) {
                      setTodos(function (todos) {
                            return todos.filter(function (t) {
                                        return t.id !== todo.id;
                                      });
                          });
                      Common.mapNullable(containerRef.current, (function (containerEl) {
                              Common.focusPreviousClass(Types.listItemClass, containerEl);
                            }));
                    }
                    if (e.key === "Enter" && e.metaKey) {
                      Core__Option.mapOr(Core__Array.findIndexOpt(getTodos(), (function (v) {
                                  return v.id === todo.id;
                                })), undefined, (function (todoIndex) {
                              newTodoAfter(todoIndex, todo.parentTodo);
                            }));
                    }
                    if (e.key === "Enter") {
                      e.preventDefault();
                      Common.mapNullable(inputRef.current, (function (inputEl) {
                              inputEl.focus();
                              inputEl.selectionStart = Caml_option.nullable_to_opt(inputEl.selectionEnd);
                            }));
                    }
                    if (e.key === "Escape") {
                      setSelectedElement(function (param) {
                            
                          });
                      setDisplayElement(function (param) {
                            
                          });
                      dom.blur();
                      return ;
                    }
                    
                  }));
    }
    
  };
  var onKeyDownInput = function (e) {
    setStagedForDelete(function (param) {
          return false;
        });
    if (isSelected) {
      if (e.key === "Escape") {
        e.stopPropagation();
        Common.mapNullable(containerRef.current, (function (dom) {
                dom.focus();
              }));
      }
      return Common.mapNullable(inputRef.current, (function (dom) {
                    var cursorPosition = Core__Option.getOr(Caml_option.nullable_to_opt(dom.selectionStart), 0);
                    var inputValueLength = dom.value.length;
                    if (e.key === "]" && e.metaKey && Core__Option.mapOr(todo.childNumber, false, (function (childNumber) {
                              return childNumber !== 0;
                            }))) {
                      e.preventDefault();
                      var todos = getTodos();
                      var newParent = todos.find(function (t) {
                            if (Caml_obj.equal(t.parentTodo, todo.parentTodo)) {
                              return Caml_obj.equal(t.childNumber, Core__Option.map(todo.childNumber, (function (c) {
                                                return c - 1 | 0;
                                              })));
                            } else {
                              return false;
                            }
                          });
                      setTodos(function (todos) {
                            return todos.map(function (t) {
                                        if (t.id === todo.id) {
                                          return {
                                                  id: t.id,
                                                  text: t.text,
                                                  project: t.project,
                                                  status: t.status,
                                                  box: t.box,
                                                  parentTodo: Core__Option.map(newParent, (function (t) {
                                                          return t.id;
                                                        })),
                                                  depth: t.depth,
                                                  childNumber: t.childNumber
                                                };
                                        } else if (Caml_obj.equal(t.parentTodo, todo.id)) {
                                          return {
                                                  id: t.id,
                                                  text: t.text,
                                                  project: t.project,
                                                  status: t.status,
                                                  box: t.box,
                                                  parentTodo: Core__Option.map(newParent, (function (t) {
                                                          return t.id;
                                                        })),
                                                  depth: t.depth,
                                                  childNumber: t.childNumber
                                                };
                                        } else {
                                          return t;
                                        }
                                      });
                          });
                    }
                    if (e.key === "[" && e.metaKey && todo.parentTodo !== undefined) {
                      e.preventDefault();
                      var todos$1 = getTodos();
                      var todoIndex = todos$1.findIndex(function (t) {
                            return t.id === todo.id;
                          });
                      var todosGoingBack = todos$1.slice(0, todoIndex).toReversed();
                      var todosGoingForward = todos$1.slice(todoIndex + 1 | 0);
                      Core__Option.mapOr(todo.depth, undefined, (function (todoDepth) {
                              var newChildren = {
                                contents: []
                              };
                              var $$break = false;
                              var i = 0;
                              while(!$$break && i < todosGoingForward.length) {
                                var t = todosGoingForward[i];
                                if (Core__Option.mapOr(t.depth, false, (function (d) {
                                          return d < todoDepth;
                                        }))) {
                                  $$break = true;
                                } else {
                                  if (Core__Option.mapOr(t.depth, false, (function (d) {
                                            return d === todoDepth;
                                          }))) {
                                    newChildren.contents = newChildren.contents.concat([t.id]);
                                  }
                                  i = i + 1 | 0;
                                }
                              };
                              var newParent = Core__Option.map(todosGoingBack.find(function (t) {
                                        return Caml_obj.equal(t.depth, todoDepth - 2 | 0);
                                      }), (function (t) {
                                      return t.id;
                                    }));
                              setTodos(function (todos) {
                                    return todos.map(function (t) {
                                                if (t.id === todo.id) {
                                                  return {
                                                          id: t.id,
                                                          text: t.text,
                                                          project: t.project,
                                                          status: t.status,
                                                          box: t.box,
                                                          parentTodo: newParent,
                                                          depth: t.depth,
                                                          childNumber: t.childNumber
                                                        };
                                                } else if (newChildren.contents.includes(t.id)) {
                                                  return {
                                                          id: t.id,
                                                          text: t.text,
                                                          project: t.project,
                                                          status: t.status,
                                                          box: t.box,
                                                          parentTodo: todo.id,
                                                          depth: t.depth,
                                                          childNumber: t.childNumber
                                                        };
                                                } else {
                                                  return t;
                                                }
                                              });
                                  });
                            }));
                    }
                    if (e.key === "ArrowUp") {
                      e.stopPropagation();
                      if (cursorPosition === 0) {
                        e.preventDefault();
                        Common.mapNullable(containerRef.current, (function (dom) {
                                dom.focus();
                              }));
                      }
                      
                    }
                    if (e.key === "ArrowDown") {
                      e.stopPropagation();
                      if (cursorPosition === inputValueLength) {
                        e.preventDefault();
                        Common.mapNullable(containerRef.current, (function (dom) {
                                dom.focus();
                              }));
                      }
                      
                    }
                    if (e.key === "Backspace" && inputValueLength === 0) {
                      if (stagedForDelete) {
                        setTodos(function (todos) {
                              return todos.filter(function (t) {
                                          return t.id !== todo.id;
                                        });
                            });
                        Common.mapNullable(containerRef.current, (function (containerEl) {
                                Common.focusPreviousClass(Types.listItemClass, containerEl);
                              }));
                      } else {
                        setStagedForDelete(function (param) {
                              return true;
                            });
                      }
                    }
                    if (e.key === "Enter" && cursorPosition === inputValueLength) {
                      e.stopPropagation();
                      return Core__Option.mapOr(Core__Array.findIndexOpt(getTodos(), (function (v) {
                                        return v.id === todo.id;
                                      })), undefined, (function (todoIndex) {
                                    newTodoAfter(todoIndex, todo.parentTodo);
                                  }));
                    }
                    
                  }));
    }
    
  };
  return JsxRuntime.jsxs("div", {
              children: [
                Core__Array.make(Core__Option.getOr(todo.depth, 0), false).map(function (param, i) {
                      return JsxRuntime.jsx("div", {
                                  className: "h-full w-3 border-l ml-1"
                                }, i.toString());
                    }),
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsx(Common.StatusSelect.make, {
                              status: todo.status,
                              setStatus: (function (newStatus) {
                                  updateTodo(todo.id, (function (t) {
                                          return {
                                                  id: t.id,
                                                  text: t.text,
                                                  project: t.project,
                                                  status: newStatus,
                                                  box: t.box === "Archive" && !Types.statusIsResolved(newStatus) ? "Working" : t.box,
                                                  parentTodo: t.parentTodo,
                                                  depth: t.depth,
                                                  childNumber: t.childNumber
                                                };
                                        }));
                                }),
                              focusTodo: (function () {
                                  setFocusIdNext(function (param) {
                                        return Types.getTodoId(todo.id);
                                      });
                                }),
                              isOpen: match[0],
                              isPinned: todo.box === "Pinned",
                              isArchived: todo.box === "Archive",
                              onOpenChange: (function (v) {
                                  if (v) {
                                    return setStatusSelectIsOpen(function (param) {
                                                return v;
                                              });
                                  } else {
                                    Common.mapNullable(containerRef.current, (function (dom) {
                                            dom.focus();
                                          }));
                                    return setStatusSelectIsOpen(function (param) {
                                                return v;
                                              });
                                  }
                                })
                            }),
                        JsxRuntime.jsxs("div", {
                              children: [
                                JsxRuntime.jsx("input", {
                                      ref: Caml_option.some(inputRef),
                                      className: [
                                          Types.todoInputClass,
                                          "mx-1 block text-sm font-medium  w-full h-5 border-0 px-0.5 py-0 focus:ring-0 \n              focus:text-blue-600 leading-none "
                                        ].join(" "),
                                      id: Types.getTodoInputId(todo.id),
                                      placeholder: "",
                                      type: "text",
                                      value: todo.text,
                                      onKeyDown: onKeyDownInput,
                                      onFocus: (function (param) {
                                          setSelectedElement(function (param) {
                                                return {
                                                        TAG: "Todo",
                                                        _0: todo.id
                                                      };
                                              });
                                          setDisplayElement(function (param) {
                                                return {
                                                        TAG: "Todo",
                                                        _0: todo.id
                                                      };
                                              });
                                        }),
                                      onBlur: (function (param) {
                                          setSelectedElement(function (param) {
                                                
                                              });
                                        }),
                                      onChange: (function (e) {
                                          updateTodo(todo.id, (function (t) {
                                                  return {
                                                          id: t.id,
                                                          text: e.target.value,
                                                          project: t.project,
                                                          status: t.status,
                                                          box: t.box,
                                                          parentTodo: t.parentTodo,
                                                          depth: t.depth,
                                                          childNumber: t.childNumber
                                                        };
                                                }));
                                        })
                                    }),
                                JsxRuntime.jsx("button", {
                                      children: JsxRuntime.jsx(Tb.TbPlus, {}),
                                      className: ["text-xs  mr-1 hidden group-hover:block"].join(" "),
                                      onClick: (function (param) {
                                          Core__Option.mapOr(Core__Array.findIndexOpt(getTodos(), (function (v) {
                                                      return v.id === todo.id;
                                                    })), undefined, (function (todoIndex) {
                                                  newTodoAfter(todoIndex, todo.id);
                                                }));
                                        })
                                    }),
                                JsxRuntime.jsx("input", {
                                      className: "border-[var(--t3)] rounded mx-1 text-blue-300 h-3.5 w-3.5 focus:ring-0 focus:outline-none focus:ring-offset-0",
                                      checked: props.isChecked,
                                      type: "checkbox",
                                      onChange: (function (e) {
                                          setChecked(function (v) {
                                                return Common.arrayToggle(v, todo.id);
                                              });
                                        })
                                    })
                              ],
                              className: "border-b flex-1 ml-1 flex flex-row h-full justify-start items-center "
                            })
                      ],
                      className: [
                          "group flex flex-row justify-start items-center h-full flex-1 pl-0.5",
                          stagedForDelete ? "bg-red-200 outline outline-1 -outline-offset-1" : (
                              isSelected ? "bg-var(--t1) outline outline-1 -outline-offset-1" : ""
                            )
                        ].join(" ")
                    })
              ],
              ref: Caml_option.some(containerRef),
              className: [
                  Types.listItemClass,
                  "group flex flex-row justify-start items-center outline-none  h-6 pl-1"
                ].join(" "),
              id: Types.getTodoId(todo.id),
              style: {},
              tabIndex: 0,
              onKeyDown: onKeyDownContainer,
              onFocus: (function (param) {
                  setSelectedElement(function (param) {
                        return {
                                TAG: "Todo",
                                _0: todo.id
                              };
                      });
                  setDisplayElement(function (param) {
                        return {
                                TAG: "Todo",
                                _0: todo.id
                              };
                      });
                }),
              onBlur: (function (param) {
                  setSelectedElement(function (param) {
                        
                      });
                  setStagedForDelete(function (param) {
                        return false;
                      });
                })
            });
}

var Todo = {
  make: Project$Todo
};

function Project(props) {
  var setChecked = props.setChecked;
  var checked = props.checked;
  var getTodos = props.getTodos;
  var setTodos = props.setTodos;
  var setFocusIdNext = props.setFocusIdNext;
  var setDisplayElement = props.setDisplayElement;
  var displayElement = props.displayElement;
  var setSelectedElement = props.setSelectedElement;
  var selectedElement = props.selectedElement;
  var updateTodo = props.updateTodo;
  var setShowArchive = props.setShowArchive;
  var project = props.project;
  var projectRef = React.useRef(null);
  var isSelected = Caml_obj.equal(selectedElement, {
        TAG: "Project",
        _0: project.id
      });
  var newTodoAfter = function (i, parentTodo) {
    var newId = Uuid.v4();
    setTodos(function (v) {
          return v.toSpliced(i + 1 | 0, 0, {
                      id: newId,
                      text: "",
                      project: project.id,
                      status: "Unsorted",
                      box: "Working",
                      parentTodo: parentTodo,
                      depth: undefined,
                      childNumber: undefined
                    });
        });
    setFocusIdNext(function (param) {
          return Types.getTodoInputId(newId);
        });
  };
  var onKeyDownProject = function (e) {
    if (isSelected) {
      if (e.key === "Enter") {
        newTodoAfter(-1, undefined);
      }
      return Common.mapNullable(projectRef.current, (function (dom) {
                    if (e.key === "ArrowUp") {
                      e.preventDefault();
                      Common.focusPreviousClass(Types.listItemClass, dom);
                    }
                    if (e.key === "ArrowDown") {
                      e.preventDefault();
                      return Common.focusNextClass(Types.listItemClass, dom);
                    }
                    
                  }));
    }
    
  };
  return JsxRuntime.jsxs("div", {
              children: [
                JsxRuntime.jsxs("div", {
                      children: [
                        JsxRuntime.jsx("div", {
                              children: project.name,
                              className: " flex-none px-2 text-sm"
                            }),
                        JsxRuntime.jsx("div", {
                              className: "flex-1"
                            }),
                        JsxRuntime.jsx("button", {
                              children: JsxRuntime.jsx(Tb.TbPlus, {}),
                              className: "text-xs rounded h-6 w-6 flex-none mr-2",
                              onClick: (function (param) {
                                  newTodoAfter(-1, undefined);
                                })
                            }),
                        JsxRuntime.jsx("button", {
                              children: props.showArchive ? JsxRuntime.jsx(Tb.TbArchive, {}) : JsxRuntime.jsx(Tb.TbArchiveOff, {}),
                              className: "text-xs rounded h-6 w-6 flex-none",
                              onClick: (function (param) {
                                  setShowArchive(function (v) {
                                        return Common.arrayToggle(v, project.id);
                                      });
                                })
                            })
                      ],
                      ref: Caml_option.some(projectRef),
                      className: [
                          Types.listItemClass,
                          "h-7 flex flex-row justify-between items-center bg-[var(--t2)] px-1 gap-1",
                          isSelected ? "outline outline-1 -outline-offset-1 " : ""
                        ].join(" "),
                      id: Types.getProjectId(project.id),
                      tabIndex: 0,
                      onKeyDown: onKeyDownProject,
                      onFocus: (function (param) {
                          setSelectedElement(function (param) {
                                return {
                                        TAG: "Project",
                                        _0: project.id
                                      };
                              });
                          setDisplayElement(function (param) {
                                return {
                                        TAG: "Project",
                                        _0: project.id
                                      };
                              });
                        }),
                      onBlur: (function (param) {
                          setSelectedElement(function (param) {
                                
                              });
                        })
                    }),
                JsxRuntime.jsx("div", {
                      children: JsxRuntime.jsx("div", {
                            children: props.todos.map(function (todo) {
                                  return JsxRuntime.jsx(Project$Todo, {
                                              todo: todo,
                                              updateTodo: updateTodo,
                                              isSelected: Caml_obj.equal(selectedElement, {
                                                    TAG: "Todo",
                                                    _0: todo.id
                                                  }),
                                              setSelectedElement: setSelectedElement,
                                              displayElement: displayElement,
                                              setDisplayElement: setDisplayElement,
                                              setTodos: setTodos,
                                              setFocusIdNext: setFocusIdNext,
                                              newTodoAfter: newTodoAfter,
                                              getTodos: getTodos,
                                              isChecked: checked.includes(todo.id),
                                              setChecked: setChecked
                                            }, Types.getTodoId(todo.id));
                                }),
                            className: "flex flex-col  "
                          })
                    })
              ],
              className: ""
            });
}

var make = Project;

export {
  Todo ,
  make ,
}
/* uuid Not a pure module */
